name: Run PostgreSQL Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_db   # Nombre de la base de datos
          POSTGRES_USER: postgres  # Usuario de PostgreSQL
          POSTGRES_PASSWORD: postgres  # Contraseña de PostgreSQL
        ports:
          - 5432:5432  # Puerto de PostgreSQL
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v3  # Descargar el código del repositorio

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'  # Usamos Python 3.8 o la versión que necesites

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt  # Instalar dependencias

    - name: Wait for PostgreSQL to be ready
      run: |
        # Esperar a que PostgreSQL esté disponible
        until PGPASSWORD=${{ secrets.PG_PASSWORD }} psql -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB} -c '\q'; do
          echo "Waiting for PostgreSQL to be available..."
          sleep 2
        done

    - name: Set up database schema and data
      run: |
        # Ejecutar el archivo SQL para crear las tablas
        PGPASSWORD=${{ secrets.PG_PASSWORD }} psql -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f 01_create_tables.sql

    - name: Insert data
      run: |
        # Ejecutar el archivo SQL para insertar los datos
        PGPASSWORD=${{ secrets.PG_PASSWORD }} psql -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f 02_insert_data.sql

    - name: Query data
      run: |
        # Ejecutar una consulta para verificar los datos insertados (opcional)
        PGPASSWORD=${{ secrets.PG_PASSWORD }} psql -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB} -f 03_retrieve_everything_from_a_table.sql

    - name: Run tests
      run: |
        # Ejecutar las pruebas de pytest
        pytest
